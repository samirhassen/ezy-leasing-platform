# EZY RNPL Database Schema

## Table: profiles

Stores user profile information linked to Supabase Auth.

**Columns:**
- `id` (uuid, primary key)
- `user_id` (uuid, references auth.users, unique, not null)
- `email` (text, not null)
- `full_name` (text, not null)
- `phone` (text, nullable)
- `emirates_id` (text, not null)
- `uae_pass_tier` (text, not null, default '3')
- `roles` (text[], not null, default ['TENANT'])
- `created_at` (timestamp, not null, default now())
- `updated_at` (timestamp, not null, default now())

**RLS Policies:**
1. "Users can view their own profile" (SELECT)
   - `auth.uid() = user_id`

2. "Admins can view all profiles" (SELECT)
   - `(auth.uid() = user_id) OR ('ADMIN' = ANY (get_current_user_role()))`

3. "Users can insert their own profile" (INSERT)
   - `auth.uid() = user_id`

4. "Users can update their own profile" (UPDATE)
   - `auth.uid() = user_id`

5. "Only admins can update user roles via function" (UPDATE)
   - `('ADMIN' = ANY (get_current_user_role())) AND (user_id <> auth.uid())`

---

## Table: audit_events

Logs all significant system actions for compliance and debugging.

**Columns:**
- `id` (uuid, primary key)
- `user_id` (uuid, nullable)
- `actor_id` (uuid, nullable)
- `action` (text, not null)
- `resource_type` (text, not null)
- `resource_id` (text, nullable)
- `metadata` (jsonb, nullable)
- `ip_address` (inet, nullable)
- `user_agent` (text, nullable)
- `created_at` (timestamp, not null, default now())

**RLS Policies:**
1. "Anyone can insert audit events" (INSERT)
   - `true`

2. "Users can view their own audit events" (SELECT)
   - `(auth.uid() = user_id) OR (auth.uid() = actor_id)`

3. "Admins can view all audit events" (SELECT)
   - `EXISTS (SELECT 1 FROM profiles p WHERE p.user_id = auth.uid() AND 'ADMIN' = ANY (p.roles))`

---

## Database Functions

### `get_current_user_role()`

Returns the roles array for the currently authenticated user.

```sql
CREATE OR REPLACE FUNCTION public.get_current_user_role()
RETURNS text[]
LANGUAGE sql
STABLE SECURITY DEFINER
SET search_path TO 'public'
AS $function$
  SELECT roles FROM public.profiles WHERE user_id = auth.uid();
$function$
Security: SECURITY DEFINER (runs with elevated privileges)
update_user_role(target_user_id uuid, new_role text)
Allows admins to change a user's role.
sql
-- Check if current user is admin
IF NOT ('ADMIN' = ANY (get_current_user_role())) THEN
  RAISE EXCEPTION 'Only admins can update user roles';
END IF;

-- Update the user's role
UPDATE public.profiles 
SET roles = ARRAY[new_role]::text[]
WHERE user_id = target_user_id;
Security: Only callable by admins, logs changes to audit_events
